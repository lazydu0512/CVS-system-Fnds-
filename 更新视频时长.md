# 🎬 更新视频时长指南

**目的**: 从实际视频文件中获取真实时长并更新到数据库

---

## 📋 功能说明

我已经添加了以下功能：

### 1. 视频工具类 `VideoUtil.java`
- 使用 JAVE 库分析视频文件
- 自动获取视频时长、分辨率等信息
- 支持本地文件和URL

### 2. 后端API接口

#### 更新单个视频时长
```
POST /api/video/{id}/update-duration
```

#### 批量更新所有视频时长
```
POST /api/video/batch-update-duration
```

---

## 🚀 使用方法

### 方法1: 使用API批量更新（推荐）

#### 步骤1: 重启后端服务

**重要**: 必须先重启后端才能加载新的依赖和代码！

```bash
# 停止当前后端服务（Ctrl+C 或关闭终端）

# 重新编译并启动
cd CVS-port
mvn clean install
mvn spring-boot:run
```

#### 步骤2: 调用批量更新接口

使用浏览器或Postman访问：

```
POST http://localhost:8080/api/video/batch-update-duration
```

或使用curl命令：

```bash
curl -X POST http://localhost:8080/api/video/batch-update-duration
```

#### 步骤3: 查看结果

后端控制台会显示更新进度：

```
开始批量更新视频时长，共 5 个视频
视频时长: 300秒 (05:00)
✓ 视频ID 1 (周杰伦演唱会精彩片段) 时长: 300秒
视频时长: 480秒 (08:00)
✓ 视频ID 2 (五月天演唱会完整版) 时长: 480秒
...
批量更新完成！成功: 5/5
```

---

### 方法2: 更新单个视频

```bash
# 更新ID为1的视频
curl -X POST http://localhost:8080/api/video/1/update-duration
```

---

## 📁 视频文件位置

确保视频文件存在于以下位置：

```
CVS-port/src/main/resources/static/video/
├── video1.mp4
├── video2.mp4
├── video3.mp4
└── ...
```

如果视频URL是：
```
http://localhost:8080/static/video/video1.mp4
```

那么实际文件路径应该是：
```
CVS-port/src/main/resources/static/video/video1.mp4
```

---

## 🔧 添加的依赖

在 `pom.xml` 中添加了 JAVE 库：

```xml
<!-- 视频处理库 - 用于获取视频时长等信息 -->
<dependency>
    <groupId>ws.schild</groupId>
    <artifactId>jave-core</artifactId>
    <version>3.3.1</version>
</dependency>
<dependency>
    <groupId>ws.schild</groupId>
    <artifactId>jave-nativebin-win64</artifactId>
    <version>3.3.1</version>
</dependency>
```

---

## 📊 数据库变化

更新前：
```sql
SELECT id, title, duration FROM video;
+----+---------------------------+----------+
| id | title                     | duration |
+----+---------------------------+----------+
|  1 | 周杰伦演唱会精彩片段      |      300 |  -- 假数据
|  2 | 五月天演唱会完整版        |      480 |  -- 假数据
+----+---------------------------+----------+
```

更新后：
```sql
SELECT id, title, duration FROM video;
+----+---------------------------+----------+
| id | title                     | duration |
+----+---------------------------+----------+
|  1 | 周杰伦演唱会精彩片段      |      245 |  -- 真实时长
|  2 | 五月天演唱会完整版        |      512 |  -- 真实时长
+----+---------------------------+----------+
```

---

## 🎯 前端自动获取时长

### 在视频上传时自动获取

修改 `VideoUpload.vue`，添加视频选择时自动获取时长的功能：

```javascript
// 当用户选择视频文件时
const handleVideoSelect = (file) => {
  const video = document.createElement('video')
  video.preload = 'metadata'
  
  video.onloadedmetadata = () => {
    // 获取视频时长（秒）
    const duration = Math.floor(video.duration)
    uploadForm.duration = duration
    console.log('视频时长:', duration, '秒')
  }
  
  video.src = URL.createObjectURL(file.raw)
}
```

---

## ⚠️ 注意事项

### 1. 视频文件必须存在
- 确保视频文件在正确的位置
- 检查文件路径和URL的对应关系

### 2. 视频格式支持
JAVE支持常见的视频格式：
- MP4
- AVI
- MOV
- MKV
- FLV
- WMV

### 3. 性能考虑
- 批量更新可能需要一些时间
- 建议在服务器负载较低时执行
- 可以在后台异步执行

---

## 🐛 故障排查

### 问题1: 无法获取视频时长

**可能原因**:
- 视频文件不存在
- 视频文件损坏
- 视频格式不支持

**解决方案**:
1. 检查视频文件是否存在
2. 尝试用播放器打开视频文件
3. 查看后端控制台的错误信息

### 问题2: 依赖下载失败

**解决方案**:
```bash
cd CVS-port
mvn clean install -U
```

### 问题3: 路径转换错误

**检查**:
- 视频URL格式是否正确
- 文件系统路径分隔符（Windows用`\`，Linux用`/`）

---

## 📝 测试步骤

### 1. 准备测试视频

将一些测试视频放到：
```
CVS-port/src/main/resources/static/video/
```

### 2. 重启后端

```bash
cd CVS-port
mvn clean install
mvn spring-boot:run
```

### 3. 调用批量更新

```bash
curl -X POST http://localhost:8080/api/video/batch-update-duration
```

### 4. 验证结果

```bash
# 查看数据库
mysql -u root -p
USE cvs_db;
SELECT id, title, duration FROM video;
```

### 5. 刷新前端

访问 http://localhost:5173/ 查看时长是否正确显示

---

## ✅ 完成后的效果

1. **数据库**: 存储真实的视频时长（秒）
2. **首页**: 显示正确的时长格式（MM:SS 或 HH:MM:SS）
3. **详情页**: 播放器显示的时长与数据库一致

---

<div align="center">

## 🎉 开始更新吧！

**第一步**: 重启后端服务  
**第二步**: 调用批量更新接口  
**第三步**: 刷新前端查看效果

</div>

