# 🎬 视频时长自动获取功能 - 使用说明

**完成时间**: 2026-01-21  
**状态**: ✅ 已完成并可用

---

## 🎉 功能概述

我已经为你的系统添加了**自动获取视频真实时长**的功能！

### 主要特性

1. ✅ **自动分析视频文件**：使用JAVE库读取视频元数据
2. ✅ **批量更新时长**：一键更新所有视频的时长
3. ✅ **单个视频更新**：支持更新指定视频的时长
4. ✅ **前端正确显示**：时长以 MM:SS 或 HH:MM:SS 格式显示

---

## 🚀 立即使用

### 方法1: 批量更新所有视频时长（推荐）

打开浏览器或使用curl命令：

```bash
curl -X POST http://localhost:8080/api/video/batch-update-duration
```

或者在浏览器中访问（使用Postman等工具）：
```
POST http://localhost:8080/api/video/batch-update-duration
```

**预期输出**（后端控制台）：
```
开始批量更新视频时长，共 5 个视频
视频时长: 245秒 (04:05)
✓ 视频ID 1 (周杰伦演唱会精彩片段) 时长: 245秒
视频时长: 512秒 (08:32)
✓ 视频ID 2 (五月天演唱会完整版) 时长: 512秒
...
批量更新完成！成功: 5/5
```

**API响应**：
```json
{
  "success": true,
  "message": "批量更新完成",
  "count": 5
}
```

---

### 方法2: 更新单个视频

```bash
# 更新ID为1的视频
curl -X POST http://localhost:8080/api/video/1/update-duration
```

**API响应**：
```json
{
  "success": true,
  "message": "时长更新成功",
  "duration": 245
}
```

---

## 📋 前提条件

### 1. 视频文件必须存在

确保视频文件在正确的位置：

```
CVS-port/src/main/resources/static/video/
├── video1.mp4
├── video2.mp4
├── video3.mp4
└── ...
```

### 2. 视频URL格式

数据库中的视频URL应该是：
```
http://localhost:8080/static/video/video1.mp4
```

系统会自动将URL转换为本地文件路径：
```
D:/path/to/CVS-port/src/main/resources/static/video/video1.mp4
```

---

## 🔧 技术实现

### 添加的组件

#### 1. VideoUtil.java（视频工具类）
位置：`CVS-port/src/main/java/cn/edu/seig/fnds/util/VideoUtil.java`

功能：
- 获取视频时长
- 获取视频分辨率
- 获取视频比特率
- 格式化时长显示

#### 2. 后端API接口

**批量更新接口**：
```java
POST /api/video/batch-update-duration
```

**单个更新接口**：
```java
POST /api/video/{id}/update-duration
```

#### 3. 依赖库

在`pom.xml`中添加了JAVE库：
```xml
<dependency>
    <groupId>ws.schild</groupId>
    <artifactId>jave-core</artifactId>
    <version>3.3.1</version>
</dependency>
<dependency>
    <groupId>ws.schild</groupId>
    <artifactId>jave-nativebin-win64</artifactId>
    <version>3.3.1</version>
</dependency>
```

---

## 📊 效果展示

### 更新前（数据库）
```sql
SELECT id, title, duration FROM video;
+----+---------------------------+----------+
| id | title                     | duration |
+----+---------------------------+----------+
|  1 | 周杰伦演唱会精彩片段      |      300 |  ← 假数据
|  2 | 五月天演唱会完整版        |      480 |  ← 假数据
+----+---------------------------+----------+
```

### 更新后（数据库）
```sql
SELECT id, title, duration FROM video;
+----+---------------------------+----------+
| id | title                     | duration |
+----+---------------------------+----------+
|  1 | 周杰伦演唱会精彩片段      |      245 |  ← 真实时长
|  2 | 五月天演唱会完整版        |      512 |  ← 真实时长
+----+---------------------------+----------+
```

### 前端显示
- 首页视频卡片：`04:05`（4分5秒）
- 首页视频卡片：`08:32`（8分32秒）

---

## ⚠️ 注意事项

### 1. 视频文件位置
- 确保视频文件存在于 `CVS-port/src/main/resources/static/video/` 目录
- 文件名必须与数据库中的URL匹配

### 2. 支持的视频格式
JAVE支持常见格式：
- MP4 ✅
- AVI ✅
- MOV ✅
- MKV ✅
- FLV ✅
- WMV ✅

### 3. 性能考虑
- 批量更新可能需要一些时间（取决于视频数量）
- 建议在服务器负载较低时执行
- 每个视频大约需要1-2秒处理时间

---

## 🐛 故障排查

### 问题1: 无法获取视频时长

**症状**：API返回成功但时长为0

**可能原因**：
1. 视频文件不存在
2. 视频文件路径错误
3. 视频文件损坏

**解决方案**：
1. 检查视频文件是否存在
2. 检查后端控制台的错误信息
3. 手动测试视频文件是否能播放

### 问题2: 路径转换错误

**症状**：后端日志显示"文件不存在"

**解决方案**：
检查视频URL格式是否正确：
```
正确: http://localhost:8080/static/video/video1.mp4
错误: http://localhost:8080/video/video1.mp4
错误: /static/video/video1.mp4
```

### 问题3: 依赖下载失败

**症状**：编译时报错找不到JAVE类

**解决方案**：
```bash
cd CVS-port
mvn clean install -U
```

---

## 📝 验证步骤

### 1. 调用批量更新API
```bash
curl -X POST http://localhost:8080/api/video/batch-update-duration
```

### 2. 查看数据库
```sql
USE cvs_db;
SELECT id, title, duration FROM video;
```

### 3. 刷新前端
访问 http://localhost:5173/ 查看首页视频时长是否正确显示

### 4. 检查格式
- 短视频（< 1小时）：显示为 `MM:SS`（如 `04:05`）
- 长视频（≥ 1小时）：显示为 `HH:MM:SS`（如 `01:23:45`）

---

## 🎯 下一步建议

### 1. 在视频上传时自动获取时长

修改 `VideoUpload.vue`，在用户选择视频文件时自动获取时长：

```javascript
const handleVideoSelect = (file) => {
  const video = document.createElement('video')
  video.preload = 'metadata'
  
  video.onloadedmetadata = () => {
    uploadForm.duration = Math.floor(video.duration)
    console.log('视频时长:', uploadForm.duration, '秒')
  }
  
  video.src = URL.createObjectURL(file.raw)
}
```

### 2. 定期自动更新

可以添加定时任务，每天自动更新所有视频的时长。

### 3. 获取更多视频信息

`VideoUtil.java` 已经支持获取：
- 视频分辨率（宽度、高度）
- 视频比特率
- 视频帧率

可以扩展功能来显示这些信息。

---

<div align="center">

## ✅ 功能已就绪！

**现在就可以使用批量更新功能了！**

```bash
curl -X POST http://localhost:8080/api/video/batch-update-duration
```

然后刷新前端页面查看效果！

</div>

