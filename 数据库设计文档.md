# 演唱会视频分享平台 - 数据库设计文档

## 📋 数据库概述

- **数据库名称**: cvs_db
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **数据库引擎**: InnoDB
- **数据库版本**: MySQL 8.0+

## 📊 ER图

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│    User     │1      N │    Video    │1      N │   Comment   │
│             ├─────────┤             ├─────────┤             │
│  用户表      │ 上传     │  视频表      │ 评论     │  评论表      │
└─────────────┘         └─────────────┘         └─────────────┘
       │                       │
       │                       │
       │M                     M│
       │                       │
       │    ┌─────────────┐    │
       └────┤ VideoLike   ├────┘
            │  点赞关系表   │
            └─────────────┘
       │                       │
       │M                     M│
       │                       │
       │    ┌─────────────┐    │
       └────┤VideoCollect ├────┘
            │  收藏关系表   │
            └─────────────┘
```

## 📝 表结构设计

### 1. user - 用户表

**表说明**: 存储用户基本信息和认证信息

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 用户ID（主键） |
| username | VARCHAR | 50 | NO | - | 用户名（唯一） |
| password | VARCHAR | 100 | NO | - | 密码 |
| nickname | VARCHAR | 50 | YES | NULL | 昵称 |
| email | VARCHAR | 100 | YES | NULL | 邮箱 |
| phone | VARCHAR | 20 | YES | NULL | 手机号 |
| avatar | VARCHAR | 255 | YES | NULL | 头像URL |
| role | TINYINT | - | NO | 0 | 角色（0:普通用户, 1:管理员） |
| status | TINYINT | - | NO | 0 | 状态（0:正常, 1:禁用） |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `username`
- INDEX: `email`, `phone`

**示例数据**:
```sql
INSERT INTO user VALUES 
(1, 'admin', '123456', '系统管理员', 'admin@cvs.com', '13800138000', NULL, 1, 0, NOW(), NOW()),
(2, 'user1', '123456', '用户一', 'user1@cvs.com', '13800138001', NULL, 0, 0, NOW(), NOW());
```

### 2. video - 视频表

**表说明**: 存储视频基本信息和元数据

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 视频ID（主键） |
| title | VARCHAR | 200 | NO | - | 视频标题 |
| description | TEXT | - | YES | NULL | 视频描述 |
| video_url | VARCHAR | 500 | NO | - | 视频URL |
| thumbnail_url | VARCHAR | 500 | YES | NULL | 缩略图URL |
| duration | INT | - | YES | 0 | 视频时长（秒） |
| city | VARCHAR | 50 | NO | - | 演唱会城市 |
| concert_date | DATE | - | YES | NULL | 演唱会日期 |
| user_id | BIGINT | - | NO | - | 上传者ID（外键） |
| view_count | INT | - | NO | 0 | 观看次数 |
| like_count | INT | - | NO | 0 | 点赞数 |
| collect_count | INT | - | NO | 0 | 收藏数 |
| comment_count | INT | - | NO | 0 | 评论数 |
| status | TINYINT | - | NO | 0 | 审核状态（0:待审核, 1:通过, 2:拒绝） |
| review_comment | VARCHAR | 500 | YES | NULL | 审核意见 |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `user_id`, `city`, `status`, `create_time`
- FOREIGN KEY: `user_id` REFERENCES `user(id)`

**示例数据**:
```sql
INSERT INTO video VALUES 
(1, '周杰伦北京演唱会', '精彩片段', '/videos/1.mp4', '/thumbs/1.jpg', 300, '北京', '2024-01-20', 2, 1000, 50, 20, 10, 1, '审核通过', NOW(), NOW());
```

### 3. comment - 评论表

**表说明**: 存储用户对视频的评论

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 评论ID（主键） |
| video_id | BIGINT | - | NO | - | 视频ID（外键） |
| user_id | BIGINT | - | NO | - | 用户ID（外键） |
| content | TEXT | - | NO | - | 评论内容 |
| parent_id | BIGINT | - | YES | NULL | 父评论ID（用于回复） |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `video_id`, `user_id`, `parent_id`, `create_time`
- FOREIGN KEY: `video_id` REFERENCES `video(id)`
- FOREIGN KEY: `user_id` REFERENCES `user(id)`

**示例数据**:
```sql
INSERT INTO comment VALUES 
(1, 1, 2, '太精彩了！', NULL, NOW()),
(2, 1, 3, '同感！', 1, NOW());
```

### 4. video_like - 视频点赞表

**表说明**: 存储用户对视频的点赞关系

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 点赞ID（主键） |
| video_id | BIGINT | - | NO | - | 视频ID（外键） |
| user_id | BIGINT | - | NO | - | 用户ID（外键） |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `video_id`, `user_id`（联合唯一索引，防止重复点赞）
- INDEX: `user_id`
- FOREIGN KEY: `video_id` REFERENCES `video(id)`
- FOREIGN KEY: `user_id` REFERENCES `user(id)`

**示例数据**:
```sql
INSERT INTO video_like VALUES 
(1, 1, 2, NOW()),
(2, 1, 3, NOW());
```

### 5. video_collect - 视频收藏表

**表说明**: 存储用户对视频的收藏关系

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 收藏ID（主键） |
| video_id | BIGINT | - | NO | - | 视频ID（外键） |
| user_id | BIGINT | - | NO | - | 用户ID（外键） |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `video_id`, `user_id`（联合唯一索引，防止重复收藏）
- INDEX: `user_id`
- FOREIGN KEY: `video_id` REFERENCES `video(id)`
- FOREIGN KEY: `user_id` REFERENCES `user(id)`

**示例数据**:
```sql
INSERT INTO video_collect VALUES 
(1, 1, 2, NOW());
```

## 🔗 表关系说明

### 一对多关系
1. **User → Video**: 一个用户可以上传多个视频
2. **Video → Comment**: 一个视频可以有多条评论
3. **User → Comment**: 一个用户可以发表多条评论

### 多对多关系
1. **User ↔ Video (点赞)**: 通过 `video_like` 表实现
2. **User ↔ Video (收藏)**: 通过 `video_collect` 表实现

## 📈 数据统计查询

### 1. 获取视频的点赞数
```sql
SELECT COUNT(*) FROM video_like WHERE video_id = ?;
```

### 2. 获取视频的收藏数
```sql
SELECT COUNT(*) FROM video_collect WHERE video_id = ?;
```

### 3. 获取用户的收藏列表
```sql
SELECT v.* FROM video v
INNER JOIN video_collect vc ON v.id = vc.video_id
WHERE vc.user_id = ?
ORDER BY vc.create_time DESC;
```

### 4. 获取热门视频（按观看数）
```sql
SELECT * FROM video 
WHERE status = 1 
ORDER BY view_count DESC 
LIMIT 10;
```

### 5. 获取待审核视频
```sql
SELECT v.*, u.nickname as uploader_name
FROM video v
LEFT JOIN user u ON v.user_id = u.id
WHERE v.status = 0
ORDER BY v.create_time DESC;
```

## 🔧 数据库优化建议

### 1. 索引优化
- 为常用查询字段添加索引
- 使用联合索引优化多条件查询
- 定期分析和优化索引

### 2. 查询优化
- 使用分页查询避免一次性加载大量数据
- 使用JOIN代替子查询
- 避免SELECT *，只查询需要的字段

### 3. 数据维护
- 定期清理无效数据
- 定期备份数据库
- 监控数据库性能

### 4. 扩展建议
- 考虑使用Redis缓存热点数据
- 考虑分库分表应对大数据量
- 考虑读写分离提高性能

## 📝 数据库初始化

完整的数据库初始化脚本请参考 `CVS-port/init.sql` 文件。

执行步骤：
```bash
# 1. 登录MySQL
mysql -u root -p

# 2. 创建数据库
CREATE DATABASE cvs_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 3. 导入数据
USE cvs_db;
source /path/to/init.sql;

# 4. 验证
SHOW TABLES;
SELECT COUNT(*) FROM user;
```

