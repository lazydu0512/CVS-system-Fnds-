# 演唱会视频分享平台 - 数据库设计文档

## 📋 数据库概述

- **数据库名称**: cvs_db
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **数据库引擎**: InnoDB
- **数据库版本**: MySQL 8.0+
- **最后更新**: 2026-02-01

## 🔒 安全特性

> **重要提示**: 系统已于2026年2月1日完成密码安全升级
> 
> - ✅ 所有用户密码使用 **BCrypt** 加密存储
> - ✅ 密码字段长度为 255 字符（存储60字符BCrypt密文）
> - ✅ 密码不可逆，数据库泄露无法获取明文
> - ✅ 抗暴力破解和彩虹表攻击

---

## 📊 ER图

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│    User     │1      N │    Video    │1      N │   Comment   │
│             ├─────────┤             ├─────────┤             │
│  用户表      │ 上传     │  视频表      │ 评论     │  评论表      │
└─────┬───────┘         └─────┬───────┘         └─────────────┘
      │                       │
      │M                     M│
      │    ┌─────────────┐    │
      └────┤ VideoLike   ├────┘
           │  点赞关系表   │
           └─────────────┘
      │                       │
      │M                     M│
      │    ┌─────────────┐    │
      └────┤VideoCollect ├────┘
           │  收藏关系表   │
           └─────────────┘
      │
      │1
      │    ┌─────────────┐
      └────┤    City     │
           │   城市表     │
      │M   └─────┬───────┘
      │         1│
      │    ┌─────┴───────┐
      └────┤CityManager  │
           │城市管理员关系表│
           └─────────────┘
      │
      │1      N┌─────────────┐
      └────────┤   Message   │
               │  消息通知表   │
               └─────────────┘
```

---

## 📝 表结构设计

### 1. user - 用户表 🔐

**表说明**: 存储用户基本信息和认证信息，密码使用BCrypt加密存储

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 用户ID（主键） |
| username | VARCHAR | 50 | NO | - | 用户名（唯一） |
| password | VARCHAR | **255** | NO | - | **密码（BCrypt加密，60字符）** 🔒 |
| nickname | VARCHAR | 100 | NO | - | 昵称 |
| email | VARCHAR | 100 | YES | NULL | 邮箱（唯一） |
| phone | VARCHAR | 20 | YES | NULL | 手机号 |
| avatar | VARCHAR | 500 | YES | NULL | 头像URL（阿里云OSS）|
| role | INT | - | NO | 0 | 角色（0:普通用户, 1:城市管理员） |
| status | INT | - | NO | 0 | 状态（0:正常, 1:禁用） |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_username` (username)
- UNIQUE KEY: `uk_email` (email)
- INDEX: `idx_role` (role)
- INDEX: `idx_status` (status)

**安全说明** 🔐:
```sql
-- 密码示例（BCrypt加密后）
-- 明文: 123456
-- 密文: $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy

-- 注册时加密：使用 BCryptPasswordEncoder.encode()
-- 登录时验证：使用 BCryptPasswordEncoder.matches(rawPassword, encodedPassword)
```

---

### 2. city - 城市表 🆕

**表说明**: 存储演唱会举办城市信息

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 城市ID（主键） |
| name | VARCHAR | 50 | NO | - | 城市名称 |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`

**示例数据**:
```sql
INSERT INTO city (name) VALUES
('北京'), ('上海'), ('广州'), ('深圳'), 
('成都'), ('杭州'), ('武汉'), ('西安');
```

---

### 3. city_manager - 城市管理员关系表 🆕

**表说明**: 存储城市管理员与城市的关联关系，一个城市只能有一个管理员

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 关系ID（主键） |
| user_id | BIGINT | - | NO | - | 城市管理员用户ID（外键） |
| city_id | BIGINT | - | NO | - | 管理的城市ID（外键） |
| create_time | DATETIME | - | YES | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_city` (city_id) - 一个城市只能有一个管理员
- INDEX: `idx_user` (user_id)
- FOREIGN KEY: `user_id` REFERENCES `user(id)` ON DELETE CASCADE
- FOREIGN KEY: `city_id` REFERENCES `city(id)` ON DELETE CASCADE

---

### 4. video - 视频表

**表说明**: 存储视频基本信息和元数据，包含审核和下架功能

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 视频ID（主键） |
| title | VARCHAR | 200 | NO | - | 视频标题 |
| description | TEXT | - | YES | NULL | 视频描述 |
| city | VARCHAR | 100 | NO | - | 演唱会城市 |
| concert_date | DATE | - | NO | - | 演唱会日期 |
| video_url | VARCHAR | 1000 | NO | - | 视频URL（阿里云OSS） |
| thumbnail_url | VARCHAR | 1000 | YES | NULL | 缩略图URL（阿里云OSS） |
| duration | INT | - | YES | NULL | 视频时长（秒） |
| uploader_id | BIGINT | - | NO | - | 上传者ID（外键） |
| status | INT | - | NO | 0 | 审核状态（0:待审核, 1:通过, 2:拒绝） |
| reviewer_id | BIGINT | - | YES | NULL | 审核人ID（外键） |
| review_time | DATETIME | - | YES | NULL | 审核时间 |
| review_comment | TEXT | - | YES | NULL | 审核意见 |
| view_count | INT | - | NO | 0 | 观看次数 |
| like_count | INT | - | NO | 0 | 点赞数 |
| collect_count | INT | - | NO | 0 | 收藏数 |
| offline_status | INT | - | YES | 0 | **下架状态（0:正常, 1:用户下架, 2:管理员下架）** 🆕 |
| offline_reason | VARCHAR | 500 | YES | NULL | **下架理由** 🆕 |
| offline_time | DATETIME | - | YES | NULL | **下架时间** 🆕 |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_uploader_id` (uploader_id)
- INDEX: `idx_status` (status)
- INDEX: `idx_city` (city)
- INDEX: `idx_create_time` (create_time)
- FOREIGN KEY: `fk_video_uploader` → `user(id)`
- FOREIGN KEY: `fk_video_reviewer` → `user(id)`

---

### 5. comment - 评论表

**表说明**: 存储用户对视频的评论，支持二级回复

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 评论ID（主键） |
| video_id | BIGINT | - | NO | - | 视频ID（外键） |
| user_id | BIGINT | - | NO | - | 用户ID（外键） |
| content | TEXT | - | NO | - | 评论内容 |
| parent_id | BIGINT | - | YES | NULL | 父评论ID（用于回复） |
| status | INT | - | NO | 0 | 状态（0:正常, 1:隐藏） |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_video_id` (video_id)
- INDEX: `idx_user_id` (user_id)
- INDEX: `idx_parent_id` (parent_id)
- INDEX: `idx_status` (status)
- FOREIGN KEY: `fk_comment_video` → `video(id)` ON DELETE CASCADE
- FOREIGN KEY: `fk_comment_user` → `user(id)`
- FOREIGN KEY: `fk_comment_parent` → `comment(id)` ON DELETE CASCADE

---

### 6. video_like - 视频点赞表

**表说明**: 存储用户对视频的点赞关系，防止重复点赞

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 点赞ID（主键） |
| video_id | BIGINT | - | NO | - | 视频ID（外键） |
| user_id | BIGINT | - | NO | - | 用户ID（外键） |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_video_user` (video_id, user_id) - 防止重复点赞
- INDEX: `idx_video_id` (video_id)
- INDEX: `idx_user_id` (user_id)
- FOREIGN KEY: `fk_like_video` → `video(id)` ON DELETE CASCADE
- FOREIGN KEY: `fk_like_user` → `user(id)`

---

### 7. video_collect - 视频收藏表

**表说明**: 存储用户对视频的收藏关系，防止重复收藏

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 收藏ID（主键） |
| video_id | BIGINT | - | NO | - | 视频ID（外键） |
| user_id | BIGINT | - | NO | - | 用户ID（外键） |
| create_time | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_collect_video_user` (video_id, user_id) - 防止重复收藏
- INDEX: `idx_video_id` (video_id)
- INDEX: `idx_user_id` (user_id)
- FOREIGN KEY: `fk_collect_video` → `video(id)` ON DELETE CASCADE
- FOREIGN KEY: `fk_collect_user` → `user(id)`

---

### 8. message - 消息通知表 🆕

**表说明**: 存储用户消息通知（点赞、评论、回复、系统通知）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 消息ID（主键） |
| user_id | BIGINT | - | NO | - | 接收消息的用户ID（外键） |
| from_user_id | BIGINT | - | NO | - | 发送消息的用户ID（外键） |
| type | INT | - | NO | - | 消息类型（1:点赞, 2:评论, 3:回复, 4:系统通知） |
| video_id | BIGINT | - | YES | NULL | 关联的视频ID |
| comment_id | BIGINT | - | YES | NULL | 关联的评论ID |
| content | VARCHAR | 500 | YES | NULL | 消息内容 |
| is_read | INT | - | NO | 0 | 是否已读（0:未读, 1:已读） |
| create_time | DATETIME | - | YES | NULL | 创建时间 |

**索引**:
- PRIMARY KEY: `id`
- INDEX: `idx_user_id` (user_id)
- INDEX: `idx_is_read` (is_read)

---

## 🔗 表关系说明

### 一对多关系
1. **User → Video**: 一个用户可以上传多个视频
2. **User → Comment**: 一个用户可以发表多条评论
3. **Video → Comment**: 一个视频可以有多条评论
4. **User → CityManager**: 一个用户可以成为多个城市的管理员
5. **City → CityManager**: 一个城市只能有一个管理员
6. **User → Message**: 一个用户可以接收多条消息

### 多对多关系
1. **User ↔ Video (点赞)**: 通过 `video_like` 表实现
2. **User ↔ Video (收藏)**: 通过 `video_collect` 表实现
3. **User ↔ City (管理)**: 通过 `city_manager` 表实现

---

## 📈 常用查询示例

### 1. 用户相关查询

```sql
-- 验证用户登录（BCrypt）
-- 注意：BCrypt验证在应用层完成
SELECT * FROM user WHERE username = ? AND status = 0;

-- 获取用户的城市管理权限
SELECT c.* FROM city c
INNER JOIN city_manager cm ON c.id = cm.city_id
WHERE cm.user_id = ?;
```

### 2. 视频相关查询

```sql
-- 获取待审核视频（城市管理员）
SELECT v.*, u.nickname as uploader_name
FROM video v
LEFT JOIN user u ON v.uploader_id = u.id
WHERE v.status = 0 
  AND v.city IN (
    SELECT c.name FROM city c
    INNER JOIN city_manager cm ON c.id = cm.city_id
    WHERE cm.user_id = ?
  )
ORDER BY v.create_time DESC;

-- 获取热门视频（已审核且未下架）
SELECT * FROM video 
WHERE status = 1 
  AND offline_status = 0
ORDER BY view_count DESC 
LIMIT 10;

-- 获取用户上传的视频
SELECT * FROM video 
WHERE uploader_id = ?
ORDER BY create_time DESC;
```

### 3. 社交互动查询

```sql
-- 检查用户是否点赞
SELECT COUNT(*) FROM video_like 
WHERE video_id = ? AND user_id = ?;

-- 获取用户收藏列表
SELECT v.* FROM video v
INNER JOIN video_collect vc ON v.id = vc.video_id
WHERE vc.user_id = ?
ORDER BY vc.create_time DESC;

-- 获取视频评论（含用户信息）
SELECT c.*, u.nickname, u.avatar
FROM comment c
INNER JOIN user u ON c.user_id = u.id
WHERE c.video_id = ? AND c.status = 0
ORDER BY c.create_time DESC;
```

### 4. 消息通知查询

```sql
-- 获取未读消息数
SELECT COUNT(*) FROM message
WHERE user_id = ? AND is_read = 0;

-- 获取用户消息列表
SELECT m.*, u.nickname as from_user_name
FROM message m
LEFT JOIN user u ON m.from_user_id = u.id
WHERE m.user_id = ?
ORDER BY m.create_time DESC
LIMIT 20;
```

---

## 🔧 数据库优化建议

### 1. 索引优化
- ✅ 为常用查询字段添加索引（已完成）
- ✅ 使用联合唯一索引防止重复（video_like, video_collect）
- 📌 定期分析和优化索引：`ANALYZE TABLE table_name;`
- 📌 监控慢查询日志

### 2. 查询优化
- ✅ 使用分页查询避免一次性加载大量数据
- ✅ 使用JOIN代替子查询提高效率
- 📌 避免SELECT *，只查询需要的字段
- 📌 合理使用索引覆盖（Covering Index）

### 3. 数据维护
- 📌 定期清理无效数据（已删除用户的相关数据）
- 📌 **定期备份数据库**（建议每日增量，每周全量）
- 📌 监控表大小和索引大小
- 📌 定期优化表：`OPTIMIZE TABLE table_name;`

### 4. 安全建议
- ✅ 密码使用BCrypt加密存储（已实施）
- ✅ 使用参数化查询防止SQL注入
- 📌 定期更新MySQL版本修复安全漏洞
- 📌 限制数据库访问IP和端口
- 📌 最小权限原则分配数据库用户权限

### 5. 扩展建议
- 📌 考虑使用Redis缓存热点数据（视频详情、热门列表）
- 📌 考虑分库分表应对大数据量（按城市或日期分表）
- 📌 考虑读写分离提高并发性能
- 📌 使用CDN加速视频和图片访问

---

## 📝 数据库初始化

### 方式一：使用 cvs_db.sql（推荐）

包含完整的表结构和数据，直接导入即可：

```bash
# 1. 登录MySQL
mysql -u root -p

# 2. 导入数据库
source /path/to/CVS-port/cvs_db.sql

# 3. 验证
USE cvs_db;
SHOW TABLES;
SELECT COUNT(*) FROM user;
```

### 方式二：使用 init.sql

基础表结构和测试数据：

```bash
# 1. 登录MySQL
mysql -u root -p

# 2. 创建数据库
CREATE DATABASE cvs_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 3. 导入数据
USE cvs_db;
source /path/to/CVS-port/init.sql;

# 4. 验证
SHOW TABLES;
SELECT COUNT(*) FROM user;
```

---

## 📊 数据库统计

| 表名 | 说明 | 预计数据量 |
|------|------|----------|
| user | 用户表 | 10,000+ |
| city | 城市表 | 100+ |
| city_manager | 城市管理员关系 | 100+ |
| video | 视频表 | 50,000+ |
| comment | 评论表 | 100,000+ |
| video_like | 点赞表 | 500,000+ |
| video_collect | 收藏表 | 100,000+ |
| message | 消息通知表 | 1,000,000+ |

---

## 🔄 版本更新记录

### v2.0 (2026-02-01) 🆕
- ✅ 用户密码BCrypt加密升级（password字段255字符）
- ✅ 新增城市表（city）
- ✅ 新增城市管理员关系表（city_manager）
- ✅ 视频表新增下架相关字段（offline_status, offline_reason, offline_time）
- ✅ 用户表头像字段长度扩展至500字符（支持OSS长URL）

### v1.0 (2024-01-20)
- 初始版本：user, video, comment, video_like, video_collect, message

---

## 📞 相关文档

- [API接口文档](./API接口文档.md)
- [开发指南](./开发指南.md)
- [密码加密改造文档](./docs/security/walkthrough.md) 🔐
- [项目启动指南](./项目启动指南.md)
